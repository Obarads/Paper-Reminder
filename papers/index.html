<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Obarads">
  <link rel="shortcut icon" href="/nanyouhagi_base_a.png" type="nanyouhagi_base_a.png">

  <!-- React lib -->
  <script src="/js/react.development.js"></script>
  <script src="/js/react-dom.development.js"></script>

  <!-- Don't use this in production: -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/tag_for_papers.js"></script>
  <script src="/js/list_for_papers.js"></script>
  <script src="/js/jquery.tablesorter.min.js"></script>

  <script src="/js/marked.js"></script>
  <!--Reference https://qiita.com/legokichi/items/27b7b865a0ab28b5d530 -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      skipStartupTypeset: true, // ページロード時のmathjax発動禁止
      extensions: ["tex2jax.js"],
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": {
        availableFonts: ["TeX"]
      }
    });
  </script>
  <script src="/js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured"></script>

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/all.css">
  <link rel="stylesheet" href="/css/tag_for_papers.css">
  <link rel="stylesheet" href="/css/papers.css">
</head>

<body class="font-noto" id="body">
  <div id="_main"></div>
  <script type="text/babel" src="/js/all.js"></script>
  <script type="text/babel">

    var tag_names = null
    var title_filter = "";

    function table_show_and_hide() {
      $('#_papers_tbody tr').each(function () {
        var sw_0 = 0;
        //var sw_0_arr = new Array(tag_names.length).fill(0);
        var sw_0_num = 0;
        $(this).find("td:eq(0) .btn-flat").each(function () {
          if (tag_names.indexOf($(this).html().replace('&amp;', '&')) >= 0) {
            sw_0_num++;
          }
        });
        //if(!sw_0_arr.inclodes(0)){
        if (sw_0_num == Object.keys(tag_names).length) {
          sw_0 = 1;
        }

        var sw_1 = 0;
        if ($(this).find("td:eq(0) .paper_title").html().match(title_filter) != null) {
          sw_1 = 1;
        }

        if (sw_0 && sw_1) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    }

    function getParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function papers_events(title) {
      $(document).on('input', '._filter_input', function () {
        var value = $(this).val();
        $('._filter_input').val(value);
        var re = new RegExp(value);
        title_filter = re;
        table_show_and_hide();
      });

      $(document).on("click", '.btn-flat', function () {
        var category_name = $(this).html().replace('&amp;', '&');
        var new_tag_names = tag_names.filter(n => n !== category_name);
        if (new_tag_names.toString() == tag_names.toString()) {
          tag_names.unshift(category_name);
        } else {
          tag_names = new_tag_names;
        }
        $('.btn-flat').each(function () {
          if (category_name == $(this).html().replace('&amp;', '&')) {
            $(this).toggleClass('hovered');
          }
        });
        if (Object.keys(tag_names).length == 0) {
          document.title = title;
          window.history.replaceState('', '', '/papers/');
        } else {
          document.title = tag_names + " - " + title;
          window.history.replaceState('', '', '?tag=' + tag_names);
        }
        table_show_and_hide();
      });

      /* table column sw */
      $(document).on("click", '.btn-column', function () {
        var column_name = $(this).html().split(' ')[0];
        var column_dict = { 'Title': 1, 'Year': 2, 'Status': 3 };
        var cn = String(column_dict[column_name]);
        $("td:nth-of-type(" + cn + ")")
          .toggleClass("column-hidden");
        $("th:nth-of-type(" + cn + ")")
          .toggleClass("column-hidden");
        $(this).toggleClass("bc-hovered");
      });

      $(document).on("click", '._initialization_button', function () {
        $('._filter_input').val('');
        $('#_papers_tbody tr').show();
        $(".btn-flat").removeClass("hovered");
        var href = (window.location.href).split("?");
        window.history.replaceState('', '', href[0]);
        title_filter = "";
        tag_names = [];
      });
    }

    function search(position, title) {
      var main_left = <SearchPanel />
      var main_right = <TablePanel />
      var add_item = <SearchPanel />

      //ReactDOM.unmountComponentAtNode(document.getElementById(position))
      ReactDOM.hydrate(
        <PapersIndex _main_left={main_left} _main_right={main_right} _add_item={add_item} />,
        document.getElementById(position)
      );

      var url_param = getParam("tag", null);
      if (url_param == null) {
        tag_names = []
        document.title = title;
      } else {
        tag_names = url_param.split(",");
        document.title = tag_names + " - " + title;
      }

      $('.btn-flat').each(function () {
        for (var i = 0; i < Object.keys(tag_names).length; i++) {
          if (tag_names[i] == $(this).html().replace('&amp;', '&')) {
            $(this).toggleClass('hovered');
          }
        }
      });

      $("#_papers_table").tablesorter({});
      table_show_and_hide();
    }

    function chenge_id() {
      var h_list = [1, 2, 3, 4, 5]
      var new_ids = []
      for (var i in h_list) {
        var h = h_list[i]
        var element = document.getElementsByTagName("h" + h)
        var counter = 0
        while (counter < element.length) {
          var new_id = "_" + h + "-" + counter
          element[counter].id = new_id
          new_ids.push(new_id)
          counter = counter + 1
        }
      }
      return new_ids
    }

    function headline(markdown, new_ids) {
      var lines = markdown.split("\n");
      var headline = [];
      var in_code = false;
      for (var it in lines) {
        if (lines[it].match(/^```.?/)) {
          // コードの行内の場合は外す
          in_code = in_code ? false : true;
        }
        if (lines[it][0] == '#' && !in_code && lines[it][1] != ' ') {
          // 先頭の#とスペースを削除して追加
          headline.push([lines[it].replace(/^#+/, '').trim(), lines[it].split(" ")[0].length]);
        }
        // #が1個だけ(記事のタイトル)の場合のみ別の処理
        if (lines[it][0] == '#' && !in_code && lines[it][1] == ' ') {
          var title = lines[it].replace(/^#+/, '').trim()
        }
      }

      // 表示用のリスト構文
      var preview = "<a style='font-size: 30px; color: white;' href=\"javascript:id_scroll('"
        + "_1-0"
        + "')\">"
        + title
        + "</a><br>";
      var counter = [0, 0, 0, 0, 0] // [h1,h2,h3,h4,h5]
      for (var it in headline) {
        preview += "<div class='toc-"
          + headline[it][1]
          + "'>"
          + "<div class='toc-con-"
          + headline[it][1]
          + "'>"
          + "<div class='toc-con2-"
          + headline[it][1]
          + "'>"
          + "<a href=\"javascript:id_scroll('"
          + "_" + headline[it][1] + "-" + counter[headline[it][1] - 1]
          + "')\">"
          + headline[it][0]
          + "</a></div></div></div>";
        counter[headline[it][1] - 1] = counter[headline[it][1] - 1] + 1
      }
      // 確認用
      $('.headline-preview').html(preview);
      // 更新用
    }

    function id_scroll(id_name) {
      var element = document.getElementById(id_name);
      element.scrollIntoView({
        behavior: 'auto',
        block: 'start',
        inline: 'nearest',
      });
    }

    function detail(position, title) {
      var main_left = <TOCPanel />
      var main_right = <MDPanel />
      var name = location.hash.slice(1) + ".md"
      var add_item = <Collapser _add_item_title="Table of Contents" _add_item_contents={main_left}/>

      ReactDOM.hydrate(
        <PapersIndex _main_left={main_left} _main_right={main_right} _add_item={add_item} />,
        document.getElementById(position)
      );

      var get = $.get;
      marked.setOptions({
        renderer: new marked.Renderer(),
        gfm: true,
        tables: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: false,
        smartypants: false
      });

      document.title = decodeURI(name).replace(".md", "") + " - " + title;

      // ページ内リンクなのでhistory.pushStateする必要はない
      get(name).catch(function () {
        return Promise.resolve("# 404 page not found");
      }).then(function (text) {
        // markedにlatexタグ食わせると&<>とかがエスケープされるので<pre />で包んで退避
        // ちなみに```mathとかで<pre><code class="lang-math">になったのはエスケープされるので注意
        var PREFIX = "<pre><code class=\"lang-math\">";
        var SUFFIX = "</code></pre>";
        var reg = new RegExp(
          ("(?:" + PREFIX + "([\\s\\S]*?)" + SUFFIX + ")")
            .replace(/\//g, "\/"),
          "gm");
        var wraped = text.split("$$")
          .reduce(function (sum, str, i) {
            return i % 2 === 0 ?
              sum + str :
              sum + PREFIX + str + SUFFIX;
          }, "");
        var html = marked(wraped);
        // 退避したlatexタグを$$で包み直す
        var _html = html;
        var tuple = null;
        while (tuple = reg.exec(html)) {
          _html = _html.split(tuple[0]).join("$$" + tuple[1] + "$$");
        }
        // mathjaxで処理
        
        var div = document.getElementById("_md_panel_contents");
        div.innerHTML = _html;
        MathJax.Hub.Configured();
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
        
        var new_ids = chenge_id()
        headline(text, new_ids)
        var div = document.getElementsByClassName("headline-preview");
        for(var i=0; i < div.length; i++){
          div[i].innerHTML
          MathJax.Hub.Configured();
          MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
        }
      }).catch(function (err) {
        // jqueryのpromiseはthenの中でエラー吐いて止まってもconsoleに表示してくれないので表示させる
        console.log("AAA")
        console.error(err);
      });
    }

    function main(event_sw) {
      // ルーティング
      var name = "";
      var position = "_main"
      var title = "Obarads/papers"
      var path = "/papers/"
      if (event_sw) {
        papers_events(title)
      }
      if (location.hash.length <= 1) {
        /**  Search page  **/
        search(position, title)
      } else {
        /**  Detail page  **/
        detail(position, title)
      }
    }

    window.addEventListener("load", function () {
      main(true);
    });
    window.addEventListener("hashchange", function () {
      main(false);
    });

  </script>
</body>

</html>