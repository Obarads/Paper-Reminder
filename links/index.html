<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Obarads">
  <link rel="shortcut icon" href="/nanyouhagi_base_a.png" type="nanyouhagi_base_a.png">

  <script src="/js/jQuery/jquery.js"></script>
  <script src="/js/jQuery/jquery.tablesorter.min.js"></script>
  <script src="/js/Other/bootstrap.min.js"></script>
  <script src="/js/Other/marked.js"></script>
  <script src="/js/build/tag_for_links.js"></script>
  <script src="/js/build/list_for_links.js"></script>
  <script src="/js/build/build.js"></script>
  <script src="/js/all.js"></script>
  <!--Reference https://qiita.com/legokichi/items/27b7b865a0ab28b5d530 -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      skipStartupTypeset: true, // ページロード時のmathjax発動禁止
      extensions: ["tex2jax.js"],
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      "HTML-CSS": {
        availableFonts: ["TeX"]
      }
    });
  </script>
  <script src="/js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML&delayStartupUntil=configured"></script>

  <link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css" />
  <link rel="stylesheet" href="/css/all.css" />
  <link rel="stylesheet" href="/css/papers.css">
  <link rel="stylesheet" href="/css/tag_for_links.css" />
  <link rel="stylesheet" href="/css/table_dark.css" />
</head>

<body class="font-default" id="body">
  <div id="main"></div>
  <script type="text/javascript">

    function main(event_sw) {
      // ルーティング
      var position = "main"
      var dir = "links"
      var path = "/"+dir+"/"
      var title = ""
      var left_panel_title = ""
      if (location.hash.length <= 1) {
        /**  Search page  **/
        title = "OPMemo/links"
        left_panel_title = "Criteria & Dispaly"
        document.getElementById("main").innerHTML = LeftAndRight()
        document.getElementById("header").innerHTML = Header()
        document.getElementById("left-panel-title").innerHTML = left_panel_title
        document.getElementById("left-panel-contents").innerHTML = Criteria()
        document.getElementsByClassName("_status_tags")[0].innerHTML = CreatingTags(tag_status_list_for_links())
        document.getElementsByClassName("_contents_tags")[0].innerHTML = CreatingTags(tag_contents_list_for_links())
        document.getElementsByClassName("_field_tags")[0].innerHTML = CreatingTags(tag_field_list_for_links())
        document.getElementsByClassName("_method_tags")[0].innerHTML = CreatingTags(tag_method_list_for_links())
        document.getElementsByClassName("_data_tags")[0].innerHTML = CreatingTags(tag_data_list_for_links())
        document.getElementsByClassName("_task_tags")[0].innerHTML = CreatingTags(tag_task_list_for_links())
        document.getElementsByClassName("_etc_tags")[0].innerHTML = CreatingTags(tag_etc_list_for_links())
        document.getElementById("header_navi").innerHTML = document.getElementById("header_navi").innerHTML + CriteriaBreadcrumbContents(dir)
        //document.getElementsByClassName("activity_log_contents")[0].innerHTML = CreatingLinksForActLog(actlog_list_for_papers())
        document.getElementById("add_item").innerHTML = document.getElementById("left-panel-contents").innerHTML
        document.getElementById("main_right").innerHTML = DocumentTable()
        document.getElementById("papers_tbody").innerHTML = CreatingLinks(information_list_for_links(),dir)

        var url_tag = getParam("tag", null);
        var tag_names = null
        if (url_tag == null) {
          tag_names = []
        } else {
          tag_names = url_tag.split(",");
        }

        $('.btn-flat').each(function () {
          for (var i = 0; i < Object.keys(tag_names).length; i++) {
            if (tag_names[i] == $(this).html().replace('&amp;', '&')) {
              $(this).toggleClass('hovered');
            }
          }
        });
        //$('._filter_input').val(title_filter);
        var title_filter = ""

        $("#_papers_table").tablesorter({});
        setting_search_parameters(tag_names, title, dir, title_filter)
        table_show_and_hide(title_filter, tag_names);
        
      } else {
        /**  Detail page  **/
        title = "OPMemo/links/detail"
        left_panel_title = "Contents"
        document.getElementById("main").innerHTML = LeftAndRight()
        document.getElementById("header").innerHTML = Header()
        document.getElementById("header_navi").innerHTML = DetailBreadcrumbContents(dir)
        document.getElementById("left-panel-title").innerHTML = left_panel_title
        document.getElementById("left-panel-contents").innerHTML = ToC("A1","B1","A2","A1")
        document.getElementById("add_item").innerHTML =  Collapser()
        document.getElementById("add_item_title").innerHTML =  left_panel_title
        document.getElementById("add_item_contents").innerHTML = ToC("B1","A1","B2","B1")
        document.getElementById("main_right").innerHTML = Container()

        var get = $.get;
        marked.setOptions({
          renderer: new marked.Renderer(),
          gfm: true,
          tables: true,
          breaks: true,
          pedantic: false,
          sanitize: false,
          smartLists: false,
          smartypants: false
        });

        var name = location.hash.slice(1) + ".md"
        document.title = decodeURI(name).replace(".md", "") + " - " + title;

        // ページ内リンクなのでhistory.pushStateする必要はない
        get(name).catch(function () {
          return Promise.resolve("# 404 page not found");
        }).then(function (text) {
          // markedにlatexタグ食わせると&<>とかがエスケープされるので<pre />で包んで退避
          // ちなみに```mathとかで<pre><code class="lang-math">になったのはエスケープされるので注意
          var PREFIX = "<pre><code class=\"lang-math\">";
          var SUFFIX = "</code></pre>";
          var reg = new RegExp(
            ("(?:" + PREFIX + "([\\s\\S]*?)" + SUFFIX + ")")
              .replace(/\//g, "\/"),
            "gm");
          var wraped = text.split("$$")
            .reduce(function (sum, str, i) {
              return i % 2 === 0 ?
                sum + str :
                sum + PREFIX + str + SUFFIX;
            }, "");
          var html = marked(wraped);
          // 退避したlatexタグを$$で包み直す
          var _html = html;
          var tuple = null;
          while (tuple = reg.exec(html)) {
            _html = _html.split(tuple[0]).join("$$" + tuple[1] + "$$");
          }
          // mathjaxで処理
          var div = document.getElementById("right-panel");
          div.innerHTML = _html;
          MathJax.Hub.Configured();
          MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);

          // tocに対する処理
          $('.toc-contents').html(chenge_id_and_headline(text));
          var toc_contents = document.getElementsByClassName("toc-contents");
          //var toc_title = document.getElementsByClassName("toc-title");
          for (var i = 0; i < toc_contents.length; i++) {
            MathJax.Hub.Configured();
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, toc_contents[i]]);
          }
        }).catch(function (err) {
          // jqueryのpromiseはthenの中でエラー吐いて止まってもconsoleに表示してくれないので表示させる
          console.error(err);
        });
      }
      if (event_sw) {
        event_start(title, dir, tag_names)
      }
    }

    window.addEventListener("load", function () {
      main(true);
    });
    window.addEventListener("hashchange", function () {
      main(false);
    });

  </script>
</body>

</html>